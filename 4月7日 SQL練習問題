-- 11/ 各グループごとの総得点数を表示して下さい。
select
  countries.group_name
  , count(goals.id) as "COUNT(g.id)" 
from
  goals 
  left join pairings 
    on goals.pairing_id = pairings.id 
  left join countries 
    on countries.id = pairings.my_country_id 
where
  pairings.kickoff between '2014-06-13' and '2014-06-27' 
group by
  countries.group_name 
order by
  countries.group_name; 

-- 12/ 日本VSコロンビア戦（pairings.id = 103）でのコロンビアの得点のゴール時間を表示してください
select
  goal_time 
from
  goals 
where
  pairing_id = 103; 

-- 13/ 日本VSコロンビア戦の勝敗を表示して下さい。
select
  countries.name
  , count(goals.goal_time) as "COUNT(goals.goal_time)" 
from
  goals 
  left join pairings 
    on goals.pairing_id = pairings.id 
  left join countries 
    on pairings.my_country_id = countries.id 
where
  pairings.id = 39 
  or pairings.id = 103 
group by
  countries.name 
order by
  COUNT(goals.goal_time); 

-- 14/ グループCの各対戦毎にゴール数を表示してください。
select
  p1.kickoff
  , c1.name as my_country
  , c2.name as enemy_country
  , c1.ranking as my_ranking
  , c2.ranking as enemy_ranking
  , count(goals.id) as my_goals 
from
  pairings p1 
  left join countries c1 
    on p1.my_country_id = c1.id 
  left join countries c2 
    on p1.enemy_country_id = c2.id 
  left join goals 
    on goals.pairing_id = p1.id 
where
  c1.group_name = 'C' 
  and c2.group_name = 'C' 
group by
  p1.kickoff
  , c1.name
  , c2.name
  , c1.ranking
  , c2.ranking 
order by
  p1.kickoff
  , c1.ranking; 

-- 15/ グループCの各対戦毎にゴール数を表示してください。
select
  p1.kickoff
  , c1.name as my_country
  , c2.name as enemy_country
  , c1.ranking as my_ranking
  , c2.ranking as enemy_ranking
  , ( 
    select
      count(id) 
    from
      goals 
    where
      p1.id = goals.pairing_id
  ) as my_goals 
from
  pairings p1 
  left join countries c1 
    on p1.my_country_id = c1.id 
  left join countries c2 
    on p1.enemy_country_id = c2.id 
  left join goals 
    on goals.pairing_id = p1.id 
where
  c1.group_name = 'C' 
  and c2.group_name = 'C' 
order by
  p1.kickoff
  , c1.ranking; 

-- 16/ グループCの各対戦毎にゴール数を表示してください。
select
  p1.kickoff
  , c1.name as my_country
  , c2.name as enemy_country
  , c1.ranking as my_ranking
  , c2.ranking as enemy_ranking
  , ( 
    select
      count(g1.id) 
    from
      goals g1 
    where
      p1.id = g1.pairing_id
  ) as my_goals
  , ( 
    select
      count(g2.id) 
    from
      goals g2 
      left join pairings p2 
        on p2.id = g2.pairing_id 
    where
      p2.my_country_id = p1.enemy_country_id 
      AND p2.enemy_country_id = p1.my_country_id
  ) as enemy_goals 
from
  pairings p1 
  left join countries c1 
    on p1.my_country_id = c1.id 
  left join countries c2 
    on p1.enemy_country_id = c2.id 
where
  c1.group_name = 'C' 
  and c2.group_name = 'C' 
order by
  p1.kickoff
  , c1.ranking; 

-- 17/ 問題16の結果に得失点差を追加してください。
select
  p1.kickoff
  , c1.name as my_country
  , c2.name as enemy_country
  , c1.ranking as my_ranking
  , c2.ranking as enemy_ranking
  , ( 
    select
      count(g1.id) 
    from
      goals g1 
    where
      p1.id = g1.pairing_id
  ) as my_goals
  , ( 
    select
      count(g2.id) 
    from
      goals g2 
      left join pairings p2 
        on p2.id = g2.pairing_id 
    where
      p2.my_country_id = p1.enemy_country_id 
      AND p2.enemy_country_id = p1.my_country_id
  ) as enemy_goals
  , ( 
    select
      count(g1.id) 
    from
      goals g1 
    where
      p1.id = g1.pairing_id
  ) - ( 
    select
      count(g2.id) 
    from
      goals g2 
      left join pairings p2 
        on p2.id = g2.pairing_id 
    where
      p2.my_country_id = p1.enemy_country_id 
      AND p2.enemy_country_id = p1.my_country_id
  ) as goal_diff 
from
  pairings p1 
  left join countries c1 
    on p1.my_country_id = c1.id 
  left join countries c2 
    on p1.enemy_country_id = c2.id 
where
  c1.group_name = 'C' 
  and c2.group_name = 'C' 
order by
  p1.kickoff
  , c1.ranking; 

-- 18/ ブラジル（my_country_id = 1）対クロアチア（enemy_country_id = 4）戦のキックオフ時間（現地時間）を表示してください。
select
  p.kickoff
  , p.kickoff - interval '12' hour as kickoff_jp 
from
  pairings p 
where
  p.my_country_id = 1 
  and p.enemy_country_id = 4; 

-- 19/ 年齢ごとの選手数を表示してください。（年齢はワールドカップ開催当時である2014-06-13を使って算出してください。）
select
  extract(year from age('2014-06-13', birth)) as age
  , count(id) 
from
  players 
group by
  age 
order by
  age; 

-- 20/ 年齢ごとの選手数を表示してください。ただし、10歳毎に合算して表示してください。
select
  trunc( 
    extract(year from age('2014-06-13', birth))
    , - 1
  ) as age
  , count(id) as player_count 
from
  players 
group by
  age;
